use std::{
    ffi::CString,
    path::Path,
    slice::{from_raw_parts, from_raw_parts_mut},
};

use compiled_nn_bindings;

pub struct CompiledNN {
    core: compiled_nn_bindings::CompiledNN,
}

impl Default for CompiledNN {
    fn default() -> Self {
        Self {
            core: unsafe { compiled_nn_bindings::CompiledNN::new() },
        }
    }
}

impl Drop for CompiledNN {
    fn drop(&mut self) {
        unsafe { self.core.destruct() }
    }
}

impl CompiledNN {
    pub fn compile<P>(&mut self, filename: P)
    where
        P: AsRef<Path>,
    {
        let filename =
            CString::new(filename.as_ref().to_str().unwrap()).expect("CString::new failed");
        unsafe { self.core.compile(filename.as_ptr()) }
    }

    pub fn input(&mut self, index: usize) -> &mut [f32] {
        unsafe {
            let input = self.core.input(index as u64);
            let input_size = self.core.inputSize(index as u64);
            from_raw_parts_mut(input, input_size as usize)
        }
    }

    pub fn output(&mut self, index: usize) -> &[f32] {
        unsafe {
            let output = self.core.output(index as u64);
            let output_size = self.core.outputSize(index as u64);
            from_raw_parts(output, output_size as usize)
        }
    }

    pub fn apply(&mut self) {
        unsafe { self.core.apply() }
    }
}

#[test]
fn test_test() {
    let image = [
        [
            [80.0],
            [85.0],
            [89.0],
            [86.0],
            [80.0],
            [80.0],
            [82.0],
            [86.0],
            [89.0],
            [88.0],
            [87.0],
            [91.0],
            [91.0],
            [89.0],
            [91.0],
            [88.0],
            [89.0],
            [91.0],
            [93.0],
            [96.0],
            [93.0],
            [91.0],
            [89.0],
            [91.0],
            [90.0],
            [87.0],
            [84.0],
            [84.0],
            [86.0],
            [87.0],
            [95.0],
            [89.0],
        ],
        [
            [83.0],
            [82.0],
            [86.0],
            [89.0],
            [83.0],
            [79.0],
            [85.0],
            [89.0],
            [93.0],
            [90.0],
            [86.0],
            [83.0],
            [84.0],
            [83.0],
            [84.0],
            [79.0],
            [80.0],
            [88.0],
            [91.0],
            [92.0],
            [90.0],
            [89.0],
            [92.0],
            [95.0],
            [93.0],
            [86.0],
            [82.0],
            [88.0],
            [86.0],
            [90.0],
            [92.0],
            [87.0],
        ],
        [
            [81.0],
            [81.0],
            [79.0],
            [83.0],
            [81.0],
            [79.0],
            [87.0],
            [85.0],
            [83.0],
            [78.0],
            [78.0],
            [79.0],
            [83.0],
            [83.0],
            [80.0],
            [79.0],
            [82.0],
            [82.0],
            [79.0],
            [81.0],
            [83.0],
            [87.0],
            [89.0],
            [91.0],
            [88.0],
            [90.0],
            [80.0],
            [80.0],
            [81.0],
            [84.0],
            [86.0],
            [80.0],
        ],
        [
            [87.0],
            [92.0],
            [81.0],
            [85.0],
            [83.0],
            [84.0],
            [92.0],
            [93.0],
            [87.0],
            [88.0],
            [85.0],
            [83.0],
            [80.0],
            [85.0],
            [87.0],
            [85.0],
            [88.0],
            [88.0],
            [89.0],
            [90.0],
            [91.0],
            [87.0],
            [82.0],
            [82.0],
            [77.0],
            [77.0],
            [73.0],
            [76.0],
            [72.0],
            [73.0],
            [75.0],
            [75.0],
        ],
        [
            [91.0],
            [93.0],
            [86.0],
            [86.0],
            [85.0],
            [87.0],
            [86.0],
            [82.0],
            [82.0],
            [85.0],
            [83.0],
            [78.0],
            [77.0],
            [83.0],
            [87.0],
            [93.0],
            [84.0],
            [84.0],
            [86.0],
            [88.0],
            [93.0],
            [95.0],
            [89.0],
            [84.0],
            [78.0],
            [83.0],
            [80.0],
            [80.0],
            [77.0],
            [79.0],
            [75.0],
            [78.0],
        ],
        [
            [82.0],
            [85.0],
            [77.0],
            [69.0],
            [70.0],
            [75.0],
            [75.0],
            [79.0],
            [80.0],
            [80.0],
            [80.0],
            [79.0],
            [81.0],
            [85.0],
            [89.0],
            [91.0],
            [90.0],
            [92.0],
            [86.0],
            [85.0],
            [90.0],
            [82.0],
            [82.0],
            [78.0],
            [78.0],
            [81.0],
            [72.0],
            [75.0],
            [75.0],
            [74.0],
            [78.0],
            [85.0],
        ],
        [
            [79.0],
            [78.0],
            [77.0],
            [73.0],
            [70.0],
            [72.0],
            [74.0],
            [68.0],
            [75.0],
            [83.0],
            [87.0],
            [83.0],
            [86.0],
            [90.0],
            [98.0],
            [104.0],
            [110.0],
            [115.0],
            [110.0],
            [102.0],
            [100.0],
            [96.0],
            [91.0],
            [81.0],
            [81.0],
            [81.0],
            [81.0],
            [82.0],
            [78.0],
            [85.0],
            [92.0],
            [94.0],
        ],
        [
            [78.0],
            [79.0],
            [76.0],
            [77.0],
            [72.0],
            [73.0],
            [74.0],
            [73.0],
            [79.0],
            [83.0],
            [87.0],
            [90.0],
            [95.0],
            [99.0],
            [105.0],
            [116.0],
            [116.0],
            [118.0],
            [108.0],
            [101.0],
            [103.0],
            [103.0],
            [98.0],
            [94.0],
            [92.0],
            [94.0],
            [94.0],
            [90.0],
            [86.0],
            [92.0],
            [93.0],
            [94.0],
        ],
        [
            [70.0],
            [76.0],
            [79.0],
            [79.0],
            [81.0],
            [80.0],
            [78.0],
            [79.0],
            [82.0],
            [83.0],
            [93.0],
            [116.0],
            [146.0],
            [164.0],
            [186.0],
            [204.0],
            [211.0],
            [207.0],
            [187.0],
            [148.0],
            [113.0],
            [103.0],
            [99.0],
            [100.0],
            [103.0],
            [103.0],
            [96.0],
            [91.0],
            [90.0],
            [97.0],
            [102.0],
            [94.0],
        ],
        [
            [74.0],
            [80.0],
            [81.0],
            [78.0],
            [80.0],
            [80.0],
            [83.0],
            [84.0],
            [85.0],
            [103.0],
            [160.0],
            [212.0],
            [236.0],
            [240.0],
            [240.0],
            [242.0],
            [245.0],
            [246.0],
            [247.0],
            [240.0],
            [202.0],
            [135.0],
            [92.0],
            [92.0],
            [90.0],
            [88.0],
            [90.0],
            [92.0],
            [96.0],
            [109.0],
            [117.0],
            [114.0],
        ],
        [
            [81.0],
            [80.0],
            [78.0],
            [78.0],
            [82.0],
            [81.0],
            [83.0],
            [92.0],
            [108.0],
            [177.0],
            [226.0],
            [237.0],
            [242.0],
            [238.0],
            [233.0],
            [238.0],
            [241.0],
            [245.0],
            [245.0],
            [244.0],
            [227.0],
            [159.0],
            [120.0],
            [89.0],
            [89.0],
            [84.0],
            [86.0],
            [93.0],
            [98.0],
            [103.0],
            [103.0],
            [96.0],
        ],
        [
            [75.0],
            [82.0],
            [86.0],
            [89.0],
            [83.0],
            [78.0],
            [81.0],
            [87.0],
            [156.0],
            [223.0],
            [231.0],
            [235.0],
            [224.0],
            [175.0],
            [139.0],
            [188.0],
            [228.0],
            [240.0],
            [236.0],
            [236.0],
            [211.0],
            [103.0],
            [92.0],
            [95.0],
            [92.0],
            [81.0],
            [81.0],
            [80.0],
            [87.0],
            [87.0],
            [93.0],
            [90.0],
        ],
        [
            [80.0],
            [86.0],
            [86.0],
            [86.0],
            [80.0],
            [82.0],
            [89.0],
            [94.0],
            [188.0],
            [220.0],
            [223.0],
            [206.0],
            [140.0],
            [90.0],
            [85.0],
            [95.0],
            [147.0],
            [220.0],
            [232.0],
            [231.0],
            [215.0],
            [136.0],
            [76.0],
            [85.0],
            [97.0],
            [76.0],
            [71.0],
            [69.0],
            [76.0],
            [82.0],
            [84.0],
            [82.0],
        ],
        [
            [80.0],
            [78.0],
            [79.0],
            [83.0],
            [84.0],
            [87.0],
            [86.0],
            [102.0],
            [196.0],
            [218.0],
            [222.0],
            [156.0],
            [79.0],
            [77.0],
            [79.0],
            [86.0],
            [126.0],
            [220.0],
            [229.0],
            [227.0],
            [223.0],
            [198.0],
            [114.0],
            [68.0],
            [114.0],
            [85.0],
            [77.0],
            [82.0],
            [84.0],
            [83.0],
            [91.0],
            [93.0],
        ],
        [
            [77.0],
            [79.0],
            [78.0],
            [82.0],
            [87.0],
            [82.0],
            [81.0],
            [138.0],
            [204.0],
            [211.0],
            [216.0],
            [177.0],
            [74.0],
            [69.0],
            [71.0],
            [80.0],
            [164.0],
            [219.0],
            [218.0],
            [215.0],
            [212.0],
            [205.0],
            [172.0],
            [113.0],
            [134.0],
            [91.0],
            [78.0],
            [83.0],
            [87.0],
            [93.0],
            [94.0],
            [91.0],
        ],
        [
            [76.0],
            [76.0],
            [79.0],
            [86.0],
            [83.0],
            [76.0],
            [78.0],
            [172.0],
            [199.0],
            [203.0],
            [207.0],
            [200.0],
            [108.0],
            [85.0],
            [103.0],
            [121.0],
            [195.0],
            [211.0],
            [208.0],
            [207.0],
            [208.0],
            [203.0],
            [195.0],
            [189.0],
            [172.0],
            [103.0],
            [81.0],
            [82.0],
            [85.0],
            [92.0],
            [91.0],
            [93.0],
        ],
        [
            [74.0],
            [72.0],
            [76.0],
            [78.0],
            [83.0],
            [87.0],
            [107.0],
            [179.0],
            [193.0],
            [197.0],
            [202.0],
            [200.0],
            [180.0],
            [177.0],
            [185.0],
            [196.0],
            [201.0],
            [202.0],
            [200.0],
            [198.0],
            [197.0],
            [194.0],
            [189.0],
            [184.0],
            [171.0],
            [114.0],
            [84.0],
            [84.0],
            [90.0],
            [89.0],
            [90.0],
            [91.0],
        ],
        [
            [81.0],
            [78.0],
            [76.0],
            [78.0],
            [83.0],
            [93.0],
            [140.0],
            [177.0],
            [187.0],
            [190.0],
            [193.0],
            [195.0],
            [197.0],
            [197.0],
            [195.0],
            [194.0],
            [193.0],
            [192.0],
            [192.0],
            [187.0],
            [185.0],
            [183.0],
            [182.0],
            [176.0],
            [163.0],
            [123.0],
            [90.0],
            [93.0],
            [91.0],
            [91.0],
            [100.0],
            [114.0],
        ],
        [
            [75.0],
            [73.0],
            [74.0],
            [76.0],
            [78.0],
            [87.0],
            [130.0],
            [172.0],
            [180.0],
            [184.0],
            [186.0],
            [187.0],
            [190.0],
            [191.0],
            [190.0],
            [187.0],
            [185.0],
            [184.0],
            [178.0],
            [176.0],
            [171.0],
            [166.0],
            [168.0],
            [161.0],
            [152.0],
            [116.0],
            [94.0],
            [92.0],
            [105.0],
            [131.0],
            [174.0],
            [213.0],
        ],
        [
            [67.0],
            [72.0],
            [77.0],
            [73.0],
            [78.0],
            [85.0],
            [118.0],
            [162.0],
            [172.0],
            [176.0],
            [179.0],
            [180.0],
            [181.0],
            [181.0],
            [178.0],
            [175.0],
            [174.0],
            [172.0],
            [154.0],
            [121.0],
            [105.0],
            [98.0],
            [137.0],
            [150.0],
            [139.0],
            [112.0],
            [115.0],
            [158.0],
            [202.0],
            [232.0],
            [244.0],
            [247.0],
        ],
        [
            [69.0],
            [76.0],
            [72.0],
            [72.0],
            [75.0],
            [82.0],
            [106.0],
            [144.0],
            [134.0],
            [131.0],
            [142.0],
            [172.0],
            [175.0],
            [174.0],
            [168.0],
            [164.0],
            [161.0],
            [156.0],
            [104.0],
            [45.0],
            [41.0],
            [44.0],
            [102.0],
            [134.0],
            [143.0],
            [187.0],
            [223.0],
            [241.0],
            [246.0],
            [248.0],
            [248.0],
            [250.0],
        ],
        [
            [71.0],
            [73.0],
            [73.0],
            [72.0],
            [74.0],
            [77.0],
            [81.0],
            [125.0],
            [81.0],
            [49.0],
            [67.0],
            [139.0],
            [169.0],
            [168.0],
            [161.0],
            [156.0],
            [151.0],
            [136.0],
            [65.0],
            [39.0],
            [40.0],
            [40.0],
            [86.0],
            [124.0],
            [178.0],
            [245.0],
            [248.0],
            [250.0],
            [248.0],
            [246.0],
            [248.0],
            [247.0],
        ],
        [
            [73.0],
            [72.0],
            [80.0],
            [80.0],
            [75.0],
            [74.0],
            [72.0],
            [105.0],
            [99.0],
            [49.0],
            [50.0],
            [81.0],
            [147.0],
            [163.0],
            [153.0],
            [148.0],
            [144.0],
            [113.0],
            [43.0],
            [38.0],
            [40.0],
            [55.0],
            [101.0],
            [134.0],
            [221.0],
            [242.0],
            [244.0],
            [247.0],
            [248.0],
            [243.0],
            [232.0],
            [202.0],
        ],
        [
            [81.0],
            [78.0],
            [80.0],
            [79.0],
            [79.0],
            [78.0],
            [70.0],
            [81.0],
            [103.0],
            [74.0],
            [57.0],
            [54.0],
            [116.0],
            [159.0],
            [147.0],
            [136.0],
            [127.0],
            [115.0],
            [78.0],
            [50.0],
            [60.0],
            [101.0],
            [118.0],
            [178.0],
            [241.0],
            [242.0],
            [243.0],
            [238.0],
            [220.0],
            [182.0],
            [132.0],
            [94.0],
        ],
        [
            [89.0],
            [77.0],
            [75.0],
            [73.0],
            [70.0],
            [73.0],
            [75.0],
            [83.0],
            [134.0],
            [154.0],
            [114.0],
            [83.0],
            [149.0],
            [161.0],
            [151.0],
            [133.0],
            [119.0],
            [114.0],
            [106.0],
            [97.0],
            [108.0],
            [131.0],
            [161.0],
            [215.0],
            [228.0],
            [220.0],
            [193.0],
            [152.0],
            [112.0],
            [99.0],
            [89.0],
            [77.0],
        ],
        [
            [93.0],
            [73.0],
            [64.0],
            [73.0],
            [71.0],
            [93.0],
            [150.0],
            [178.0],
            [191.0],
            [185.0],
            [162.0],
            [154.0],
            [165.0],
            [160.0],
            [151.0],
            [137.0],
            [116.0],
            [108.0],
            [109.0],
            [120.0],
            [138.0],
            [164.0],
            [196.0],
            [196.0],
            [164.0],
            [121.0],
            [92.0],
            [84.0],
            [80.0],
            [85.0],
            [83.0],
            [71.0],
        ],
        [
            [82.0],
            [71.0],
            [64.0],
            [70.0],
            [71.0],
            [72.0],
            [88.0],
            [123.0],
            [155.0],
            [167.0],
            [153.0],
            [144.0],
            [145.0],
            [145.0],
            [141.0],
            [128.0],
            [111.0],
            [102.0],
            [106.0],
            [128.0],
            [150.0],
            [176.0],
            [189.0],
            [175.0],
            [159.0],
            [134.0],
            [100.0],
            [74.0],
            [70.0],
            [74.0],
            [68.0],
            [71.0],
        ],
        [
            [78.0],
            [77.0],
            [74.0],
            [75.0],
            [87.0],
            [110.0],
            [145.0],
            [182.0],
            [196.0],
            [193.0],
            [179.0],
            [159.0],
            [140.0],
            [124.0],
            [108.0],
            [90.0],
            [80.0],
            [80.0],
            [90.0],
            [123.0],
            [156.0],
            [178.0],
            [196.0],
            [203.0],
            [201.0],
            [165.0],
            [107.0],
            [67.0],
            [67.0],
            [65.0],
            [61.0],
            [64.0],
        ],
        [
            [76.0],
            [86.0],
            [103.0],
            [142.0],
            [190.0],
            [222.0],
            [230.0],
            [230.0],
            [218.0],
            [212.0],
            [206.0],
            [202.0],
            [197.0],
            [187.0],
            [171.0],
            [142.0],
            [100.0],
            [84.0],
            [114.0],
            [148.0],
            [174.0],
            [191.0],
            [190.0],
            [161.0],
            [111.0],
            [76.0],
            [66.0],
            [67.0],
            [68.0],
            [64.0],
            [66.0],
            [64.0],
        ],
        [
            [146.0],
            [187.0],
            [215.0],
            [235.0],
            [241.0],
            [241.0],
            [241.0],
            [240.0],
            [235.0],
            [233.0],
            [230.0],
            [223.0],
            [206.0],
            [175.0],
            [136.0],
            [88.0],
            [56.0],
            [52.0],
            [59.0],
            [79.0],
            [100.0],
            [118.0],
            [96.0],
            [73.0],
            [63.0],
            [59.0],
            [63.0],
            [64.0],
            [64.0],
            [62.0],
            [62.0],
            [58.0],
        ],
        [
            [239.0],
            [246.0],
            [246.0],
            [246.0],
            [244.0],
            [244.0],
            [244.0],
            [242.0],
            [240.0],
            [233.0],
            [211.0],
            [173.0],
            [125.0],
            [81.0],
            [67.0],
            [61.0],
            [56.0],
            [57.0],
            [62.0],
            [72.0],
            [62.0],
            [63.0],
            [65.0],
            [64.0],
            [69.0],
            [60.0],
            [63.0],
            [60.0],
            [60.0],
            [57.0],
            [56.0],
            [53.0],
        ],
        [
            [248.0],
            [250.0],
            [247.0],
            [244.0],
            [244.0],
            [245.0],
            [244.0],
            [230.0],
            [195.0],
            [151.0],
            [106.0],
            [81.0],
            [69.0],
            [70.0],
            [67.0],
            [58.0],
            [54.0],
            [57.0],
            [64.0],
            [68.0],
            [63.0],
            [69.0],
            [77.0],
            [67.0],
            [63.0],
            [62.0],
            [60.0],
            [59.0],
            [59.0],
            [56.0],
            [57.0],
            [52.0],
        ],
    ];
    let mut compiled_nn = CompiledNN::default();
    compiled_nn.compile("compiled_nn_bindings/classifier.hdf5");
    let input = compiled_nn.input(0);
    for y in 0..32 {
        for x in 0..32 {
            input[x + y * 32] = image[y as usize][x as usize][0];
        }
    }
    compiled_nn.apply();
    println!("{}", compiled_nn.output(0)[0]);
}

// let mut compiled_nn = CompiledNN::new();
// let filename = CString::new("classifier.hdf5").unwrap();
// compiled_nn.compile(filename.as_ptr());
// let input = compiled_nn.input(0);
// for y in 0..32 {
//     for x in 0..32 {
//         *input.offset(x + y * 32) = image[y as usize][x as usize][0];
//     }
// }
// compiled_nn.apply();
// println!("{}", *compiled_nn.output(0));
// compiled_nn.destruct();
